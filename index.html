<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>By-Typograph</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.2.0/diff.js"></script>
    <script src="utilities_script.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="img/sloth_icon.png" type="image/x-icon"/>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <span>Loading...</span>
    </div>

    <div id="mainContent" class="container">
        <div class="full-header">
            <div class="header-container">
              <h1>By-Typo</h1>
              <p class="description">Зробіць тыпаграфскую цукерку са звычайнага тэксту.
                  <br>Паставіць прыгожыя двукоссі, неразрыўныя прабелы і г.д.</p>
            </div>
            <hr class="horizontal_line">
        </div>


        <div class="text-areas">
            <div class="input-group">
                <label for="input">Тэкст для выпраўлення:</label>
                <div id="input" class="editable-div" contenteditable="true" placeholder="Пішы тут..."></div>
            </div>
            <div class="output-group">
                <label for="output">Выпраўлены:</label>
                <div id="output" class="editable-div" contenteditable="false" placeholder="Атрымлівай выйгрыш тут!"></div>
            </div>
        </div>
        <div class="contact-info">
            <p>З памылкамі сюды:<br><a href="twitter.com/aulasau">twitter.com/aulasau</a><br><u>aulasau.public@gmail.com</u></p>
        </div>

    </div>

    <script>

        loadPythonAndSources();

        document.addEventListener('DOMContentLoaded', function() {
            const inputDiv = document.getElementById('input');
            const outputDiv = document.getElementById('output');
            let isScrolling = false;

            inputDiv.addEventListener('paste', handlePaste);
<!--            outputDiv.addEventListener('copy', (e) => {-->
<!--                const selection = window.getSelection();-->
<!--                const text = selection.toString().replace(/\u00A0/g, ' ');-->
<!--                e.clipboardData.setData('text/plain', text);-->
<!--                e.preventDefault();-->
<!--            });-->


            function synchronizeScroll(primary, secondary) {
                if (!isScrolling) {
                    isScrolling = true;

                    secondary.scrollTop = primary.scrollTop;
<!--                    const percentage = primary.scrollTop / (secondary.scrollHeight - primary.clientHeight);-->
<!--                    secondary.scrollTop = percentage * (secondary.scrollHeight - secondary.clientHeight);-->

                    secondary.scrollLeft = primary.scrollLeft;

                    setTimeout(() => { isScrolling = false; }, 20);
                }
            }

            async function updateOutput(input, output) {
                const inputText = input.innerText;
                console.log(input.innerText)
                console.log("****END OF InnerTEXT before updating**")

                try {
                    const formattedText = await formatText(inputText);
                    let highlightedText = await highlightDiff(inputText, formattedText)

                    highlightedText = highlightedText.replace(/\n/g, '<br>');

                    output.innerHTML = highlightedText || formattedText;

                    synchronizeScroll(input, output);
                } catch (error) {
                    console.error('Formatting error:', error);
                    outputDiv.value = 'Error occurred during formatting.';
                }
            }

            function debounce(func, delay) {
                let debounceTimer;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(context, args), delay);
                }
            }

            // Create a debounced version of updateOutput
            const debouncedUpdateOutput = debounce(() => {
                updateOutput(inputDiv, outputDiv).catch(error => {
                    console.error('Debounced update error:', error);
                });
            }, 300);

            inputDiv.addEventListener('input', debouncedUpdateOutput);


            // Add scroll event listeners to both textareas
            inputDiv.addEventListener('scroll', () => synchronizeScroll(inputDiv, outputDiv));
            outputDiv.addEventListener('scroll', () => synchronizeScroll(outputDiv, inputDiv));

<!--            // Initial call to set up the output on page load-->
<!--            updateOutput().catch(error => {-->
<!--                console.error('Initial update error:', error);-->
<!--            });-->

        });

    </script>

</body>
</html>