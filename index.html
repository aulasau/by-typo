<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Formatter</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
    <style>
        /* ... (same CSS as before) ... */
    </style>
</head>
<body>
    <h1>Text Formatter</h1>
    <textarea id="input" placeholder="Enter unformatted text here"></textarea>
    <button onclick="formatText()" id="formatButton">Format Text</button>
    <textarea id="output" readonly placeholder="Formatted text will appear here"></textarea>
    <div id="loading">Loading...</div>

    <script>
        let pyodide;
        let default_typo;
        let fileContent; // Declare the global variable
        async function load_it() {
            pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");
            await pyodide.runPythonAsync(`
                import micropip
                await micropip.install('regex')
            `);

            document.getElementById('loading').textContent = 'Downloading repository...';


            // File names to be loaded
            const codeFileName = 'typography_utils.py'
            const resourceFileNames = [
                'month_weekdays.txt',
                'nbsp_after_words.txt',
                'nbsp_before_words.txt',
                'nbsp_multiple_words.txt'
            ];

            // Function to load a file
            async function loadFile(filePath) {
                try {
                    const response = await fetch(filePath);
                    return await response.text();
                } catch (error) {
                    console.error('Error loading file:', error);
                    throw error;
                }
            }

            // Function to load files and write to Pyodide filesystem
            async function loadAndWriteFiles() {
                try {
                    // Create the 'resources' directory in Pyodide filesystem
                    pyodide.FS.createPath('.', 'resources', true, true);

                    for (const fileName of resourceFileNames) {
                        const filePath = `resources/${fileName}`;
                        const content = await loadFile(filePath);
                        
                        // Write the file to Pyodide filesystem
                        pyodide.FS.writeFile(filePath, content, { encoding: "utf8" });
                        console.log(`File ${fileName} loaded and written successfully`);
                    }
                    
                    const pythonCode = await loadFile(codeFileName);
                    pyodide.FS.writeFile(codeFileName, pythonCode, { encoding: "utf8" });
                    console.log(`File ${codeFileName} loaded and written successfully`);
                    
                    // Example: Read and print contents of a file using Python
                    // await pyodide.runPythonAsync(`
                    //     with open("typography_utils.py") as f:
                    //         print(f.readlines())


                    //     with open("resources/nbsp_after_words.txt") as f:
                    //         print(f.readlines())
                    // `);

                } catch (error) {
                    console.error('Error in loadAndWriteFiles:', error);
                }
            }

            // Call the function to load and write files
            loadAndWriteFiles();

            async function move_files() {
                await pyodide.runPythonAsync(`
                    from typography_utils import default_typo
                    
                    print(default_typo.weekday)
                    #print('HELLO')
                `)
            }
            setTimeout(move_files, 1000)
            // await move_files()
        }

        load_it();



        async function formatText() {
            const input = document.getElementById('input').value;
            const outputElement = document.getElementById('output');
            const loadingElement = document.getElementById('loading');
            const formatButton = document.getElementById('formatButton');

            loadingElement.textContent = 'Processing...';
            loadingElement.style.display = 'inline';
            outputElement.value = '';
            formatButton.disabled = true;

            try {
                // Run Python code using Pyodide
                const result = await pyodide.runPythonAsync(`
                    print(${JSON.stringify(input)})
                    result = default_typo.run_typographical_enhancement(${JSON.stringify(input)})
                    result
                `);

                // Convert the Python result to a JavaScript string
                outputElement.value = result.toString();

            } catch (error) {
                outputElement.value = `Error: ${error.message}`;
                console.error('Error during text formatting:', error);
            } finally {
                loadingElement.style.display = 'none';
                formatButton.disabled = false;
            }
        }
    </script>
</body>
</html>