<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>By-Typograph</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="sloth_icon.png" type="image/x-icon"/>
</head>
<body>
    <div class="container">
        <h1>By-Typo</h1>

        <div class="text-areas">
            <div class="input-group">
                <label for="input">Тэкст для выпраўлення:</label>
                <textarea id="input" placeholder="Пішы тут..."></textarea>
            </div>
            <div class="output-group">
                <label for="output">Выпраўлены:</label>
                <textarea id="output" readonly placeholder="Атрымлівай выйгрыш тут!"></textarea>
            </div>
        </div>
        <button onclick="formatText()" id="formatButton">
            <div id="loading"><div class="spinner"></div><span>Processing...</span></div>
            Фарматуем
        </button>

    </div>

    <script>
        let pyodide;
        let default_typo;
        let fileContent; // Declare the global variable

        formatButton.disabled = true;

        async function load_it() {
            pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");
            await pyodide.runPythonAsync(`
                import micropip
                await micropip.install('regex')
            `);


            // File names to be loaded
            const codeFileName = 'typography_utils.py'
            const resourceFileNames = [
                'month_weekdays.txt',
                'nbsp_after_words.txt',
                'nbsp_before_words.txt',
                'nbsp_multiple_words.txt'
            ];

            // Function to load a file
            async function loadFile(filePath) {
                try {
                    const response = await fetch(filePath);
                    return await response.text();
                } catch (error) {
                    console.error('Error loading file:', error);
                    throw error;
                }
            }

            // Function to load files and write to Pyodide filesystem
            async function loadAndWriteFiles() {
                try {
                    // Create the 'resources' directory in Pyodide filesystem
                    pyodide.FS.createPath('.', 'resources', true, true);

                    for (const fileName of resourceFileNames) {
                        const filePath = `resources/${fileName}`;
                        const content = await loadFile(filePath);

                        // Write the file to Pyodide filesystem
                        pyodide.FS.writeFile(filePath, content, { encoding: "utf8" });
                        console.log(`File ${fileName} loaded and written successfully`);
                    }

                    const pythonCode = await loadFile(codeFileName);
                    pyodide.FS.writeFile(codeFileName, pythonCode, { encoding: "utf8" });
                    console.log(`File ${codeFileName} loaded and written successfully`);

                    // Example: Read and print contents of a file using Python
                    // await pyodide.runPythonAsync(`
                    //     with open("typography_utils.py") as f:
                    //         print(f.readlines())


                    //     with open("resources/nbsp_after_words.txt") as f:
                    //         print(f.readlines())
                    // `);

                } catch (error) {
                    console.error('Error in loadAndWriteFiles:', error);
                }
            }

            async function load_typograph() {
                await pyodide.runPythonAsync(`
                    from typography_utils import default_typo
                    #print('HELLO')
                `)
            }
            // Call the function to load and write files
            await loadAndWriteFiles();
            // Load python module
            await load_typograph()
            formatButton.disabled = false;
        }

        load_it();



        async function formatText() {
            const input = document.getElementById('input').value;
            const outputElement = document.getElementById('output');
            const loadingElement = document.getElementById('loading');
            const formatButton = document.getElementById('formatButton');

            formatButton.disabled = true;

            try {
                // Run Python code using Pyodide
                const result = await pyodide.runPythonAsync(`
                    print(${JSON.stringify(input)})
                    result = default_typo.run_typographical_enhancement(${JSON.stringify(input)})
                    result
                `);

                // Convert the Python result to a JavaScript string
                outputElement.value = result.toString();

            } catch (error) {
                outputElement.value = `Error: ${error.message}`;
                console.error('Error during text formatting:', error);
            } finally {
                formatButton.disabled = false;
            }
        }
    </script>

</body>
</html>